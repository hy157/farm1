<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Tarım Oyunu - 256x172 Tarlalar</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <style>
    /* ... CSS'in değişmedi ... */
    /* Tüm stillerini buradan değiştirmene gerek yok. Sadece JS ile ilgilendik. */
  </style>
</head>
<body>
  <audio id="sound-coin" src="https://cdn.pixabay.com/audio/2022/07/26/audio_124bfa4f88.mp3"></audio>
  <audio id="sound-pay" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115bfae13d.mp3"></audio>
  <div id="game-container">
    <div id="game-area"></div>
  </div>
  <div class="status-bars">
    <div id="money-bar"><span style="font-size: 1.2em;">💰</span> <span id="money-amount">1000</span></div>
    <div id="wheat-price-bar" title="Elindeki fazla buğdayı sat">
      <img id="wheat-price-icon" src="img/wheat.webp" alt="Buğday">
      <span id="wheat-price-amount">10</span>
      <span id="wheat-price-label"></span>
    </div>
    <div id="wheat-bar">
      <img id="wheat-icon" src="img/wheat.webp" alt="Buğday">
      <span id="wheat-amount">100</span>
    </div>
  </div>
  <div id="toolbar">
    <button id="pickaxe-btn" class="tool-btn" aria-label="Kaz">⛏️</button>
    <button id="wheat-btn" class="tool-btn" aria-label="Ekin ek">🌾</button>
    <button id="sickle-btn" class="tool-btn" aria-label="Biç">✂️</button>
    <button id="remove-btn" class="tool-btn" aria-label="Sil">❌</button>
  </div>
  <div id="rotate-warning">
    <div class="icon">🔄</div>
    Lütfen ekranı <b>Dikey</b> moda çevirin<br>
    <small>(Oyun sadece dikey oynanır)</small>
  </div>
<script>
const VIRTUAL_W = 800, VIRTUAL_H = 1200; // Oyun alanı
let scale = 1, offsetLeft = 0, offsetTop = 0;
const tileW = 256, tileH = 172;

const plotImgSrc = "img/Plot.webp";
const plot1ImgSrc = "img/Plot1.webp";
const plot2ImgSrc = "img/Plot2.webp";
const plot3ImgSrc = "img/Plot3.webp";
const wheatImgSrc = "img/wheat.webp";

const soundCoin = document.getElementById('sound-coin');
const soundPay = document.getElementById('sound-pay');

let money = 1000;
let wheat = 100;
const EKIM_MALIYET = 50;
const SILME_KAZANCI = 20;

let wheatPrice = 10;
const MIN_WHEAT_PRICE = 10;
const MAX_WHEAT_PRICE = 20;

const wheatPriceBar = document.getElementById('wheat-price-bar');
const wheatPriceAmount = document.getElementById('wheat-price-amount');
const pickaxeBtn = document.getElementById('pickaxe-btn');
const wheatBtn = document.getElementById('wheat-btn');
const sickleBtn = document.getElementById('sickle-btn');
const removeBtn = document.getElementById('remove-btn');
const gameArea = document.getElementById('game-area');
const moneyBar = document.getElementById('money-bar');
const moneyAmount = document.getElementById('money-amount');
const wheatBar = document.getElementById('wheat-bar');
const wheatAmount = document.getElementById('wheat-amount');
let isPickaxe = false;
let isRemove = false;
let isWheat = false;
let isSickle = false;
let isMouseDown = false;
let plots = [];
let wheats = [];
let handledCoords = new Set();

function updateGameAreaTransform() {
  let ww = window.innerWidth, wh = window.innerHeight;
  scale = Math.min(ww / VIRTUAL_W, wh * 0.98 / VIRTUAL_H);
  offsetLeft = (ww - VIRTUAL_W * scale) / 2;
  offsetTop = ((wh * 0.98) - VIRTUAL_H * scale) / 2;
  gameArea.style.transform = `scale(${scale})`;
  gameArea.style.left = `${offsetLeft / scale}px`;
  gameArea.style.top = `${offsetTop / scale}px`;
  gameArea.style.transformOrigin = '0 0';
}
updateGameAreaTransform();
window.addEventListener('resize', () => {
  updateGameAreaTransform();
  redrawAllPlots();
});
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    checkOrientation();
    updateGameAreaTransform();
    redrawAllPlots();
  }, 350);
});
function checkOrientation() {
  const isPortrait = window.innerHeight >= window.innerWidth;
  const warning = document.getElementById('rotate-warning');
  if(isPortrait){
    warning.classList.remove('visible');
    document.getElementById('game-container').style.display = '';
    document.querySelector('.status-bars').style.display = '';
    document.getElementById('toolbar').style.display = '';
  } else {
    warning.classList.add('visible');
    document.getElementById('game-container').style.display = 'none';
    document.querySelector('.status-bars').style.display = 'none';
    document.getElementById('toolbar').style.display = 'none';
  }
}
checkOrientation();

function screenToGame(x, y) {
  return {
    x: (x - offsetLeft) / scale,
    y: (y - offsetTop) / scale
  };
}
function isoToScreen(x, y) {
  const centerX = VIRTUAL_W / 2;
  const centerY = 350;
  return {
    left: centerX + (x - y) * (tileW / 2),
    top: centerY + (x + y) * (tileH / 2)
  };
}
function screenToIso(screenX, screenY) {
  const {x, y} = screenToGame(screenX, screenY);
  const centerX = VIRTUAL_W / 2;
  const centerY = 350;
  const mouseX = x - centerX;
  const mouseY = y - centerY;
  let ix = Math.round((mouseY / (tileH / 2) + mouseX / (tileW / 2)) / 2);
  let iy = Math.round((mouseY / (tileH / 2) - mouseX / (tileW / 2)) / 2);
  return {x: ix, y: iy};
}
function plotId(x, y) { return `plot-${x}-${y}`; }
function updateMoneyBar(type) {
  moneyAmount.textContent = money;
  moneyBar.classList.remove('money-gain', 'money-lose');
  void moneyBar.offsetWidth;
  if (type === 'lose') moneyBar.classList.add('money-lose');
  else if (type === 'gain') moneyBar.classList.add('money-gain');
  setTimeout(() => moneyBar.classList.remove('money-gain', 'money-lose'), 350);
}
function updateWheatBar() { wheatAmount.textContent = wheat; }
function updateWheatPriceBar(animType) {
  wheatPriceAmount.textContent = wheatPrice;
  wheatPriceBar.classList.remove('price-gain', 'price-sell');
  void wheatPriceBar.offsetWidth;
  if(animType === 'gain') { wheatPriceBar.classList.add('price-gain'); setTimeout(()=>wheatPriceBar.classList.remove('price-gain'), 350);}
  if(animType === 'sell') { wheatPriceBar.classList.add('price-sell'); setTimeout(()=>wheatPriceBar.classList.remove('price-sell'), 450);}
}
setInterval(() => {
  wheatPrice = Math.floor(Math.random() * (MAX_WHEAT_PRICE - MIN_WHEAT_PRICE + 1)) + MIN_WHEAT_PRICE;
  updateWheatPriceBar('gain');
}, 1000);

wheatPriceBar.addEventListener('click', () => {
  const satilacak = Math.max(0, wheat - 10);
  if (satilacak === 0) return;
  const kazanc = satilacak * wheatPrice;
  const wheatBarRect = wheatBar.getBoundingClientRect();
  const priceBarRect = wheatPriceBar.getBoundingClientRect();
  animateWheatFly({
    from: { x: wheatBarRect.left + wheatBarRect.width/2 - 32, y: wheatBarRect.top + wheatBarRect.height/2 - 32 },
    to:   { x: priceBarRect.left + priceBarRect.width/2 - 32, y: priceBarRect.top + priceBarRect.height/2 - 32 },
    count: Math.min(satilacak, 7)
  });
  setTimeout(() => {
    const moneyBarRect = moneyBar.getBoundingClientRect();
    animateMoneyFloat({
      amount: kazanc,
      from: { x: priceBarRect.left + priceBarRect.width/2 - 12, y: priceBarRect.top + priceBarRect.height/2 - 12 },
      to:   { x: moneyBarRect.left + moneyBarRect.width/2 - 12, y: moneyBarRect.top + moneyBarRect.height/2 - 12 }
    });
    soundCoin.currentTime = 0; soundCoin.play();
  }, 300);
  wheat -= satilacak;
  updateWheatBar();
  setTimeout(() => {
    money += kazanc;
    updateMoneyBar('gain');
    updateWheatPriceBar('sell');
  }, 450);
});
function animateMoneyFloat({amount, from, to}) {
  const emoji = '💰';
  const sign = amount > 0 ? '+' : '';
  const colorClass = amount > 0 ? 'money-gain' : 'money-lose';
  const float = document.createElement('span');
  float.className = `money-float ${colorClass}`;
  float.textContent = `${sign}${amount} ${emoji}`;
  float.style.left = from.x + 'px';
  float.style.top = from.y + 'px';
  float.style.opacity = 1;
  document.body.appendChild(float);
  float.animate([
    {transform: 'translate(0,0) scale(1)',opacity:1},
    {transform: `translate(${to.x-from.x}px,${to.y-from.y}px) scale(1.4)`,opacity:1,offset:0.8},
    {transform: `translate(${to.x-from.x}px,${to.y-from.y}px) scale(0.7)`,opacity:0}
  ], {duration: 700,easing:'cubic-bezier(.57,.11,.82,1.39)'});
  setTimeout(() => { float.remove(); }, 750);
}
function animateWheatFly({from, to, count=1}) {
  for (let i = 0; i < count; i++) {
    const icon = document.createElement('img');
    icon.src = wheatImgSrc;
    icon.style.position = 'absolute';
    icon.style.left = from.x + 'px';
    icon.style.top = from.y + 'px';
    icon.style.width = '96px';
    icon.style.height = '96px';
    icon.style.pointerEvents = 'none';
    icon.style.opacity = 1;
    icon.style.zIndex = 100;
    icon.style.transition = 'none';
    document.body.appendChild(icon);
    const startOffsetX = (Math.random()-0.5)*16;
    const startOffsetY = (Math.random()-0.5)*16;
    icon.style.transform = `translate(${startOffsetX}px,${startOffsetY}px) scale(1)`;
    setTimeout(() => {
      icon.animate([
        { transform: `translate(${startOffsetX}px,${startOffsetY}px) scale(1)`, opacity: 1 },
        { transform: `translate(${to.x-from.x}px,${to.y-from.y}px) scale(1.4)`, opacity: 1, offset: 0.7 },
        { transform: `translate(${to.x-from.x}px,${to.y-from.y}px) scale(0.7)`, opacity: 0 }
      ], { duration: 850 + i*80, easing: 'cubic-bezier(.45,1.2,.49,1)' });
      setTimeout(() => icon.remove(), 900 + i*80);
    }, i * 100);
  }
}

function setToolMode(mode) {
  if (mode === "pickaxe") {
    isPickaxe = !isPickaxe;
    if (isPickaxe) { isRemove = false; isWheat = false; isSickle = false; }
  } else if (mode === "remove") {
    isRemove = !isRemove;
    if (isRemove) { isPickaxe = false; isWheat = false; isSickle = false; }
  } else if (mode === "wheat") {
    isWheat = !isWheat;
    if (isWheat) { isPickaxe = false; isRemove = false; isSickle = false; }
  } else if (mode === "sickle") {
    isSickle = !isSickle;
    if (isSickle) { isPickaxe = false; isRemove = false; isWheat = false; }
  }
  pickaxeBtn.classList.toggle('active', isPickaxe);
  removeBtn.classList.toggle('active', isRemove);
  wheatBtn.classList.toggle('active', isWheat);
  sickleBtn.classList.toggle('active', isSickle);

  if (isPickaxe || isRemove || isWheat || isSickle)
    gameArea.style.cursor = "pointer";
  else
    gameArea.style.cursor = "default";
}

pickaxeBtn.addEventListener('click', () => setToolMode("pickaxe"));
removeBtn.addEventListener('click', () => setToolMode("remove"));
wheatBtn.addEventListener('click', () => setToolMode("wheat"));
sickleBtn.addEventListener('click', () => setToolMode("sickle"));

function addPlot(x, y, mousePos = null) {
  if (plots.find(p => p.x === x && p.y === y)) return false;
  if (money < EKIM_MALIYET) return false;
  plots.push({x, y});
  const coords = isoToScreen(x, y);
  const img = document.createElement('img');
  img.src = plotImgSrc;
  img.className = "iso-plot";
  img.style.left = coords.left + "px";
  img.style.top = coords.top + "px";
  img.id = plotId(x, y);
  img.style.zIndex = 1000 + (x + y); // ENTEGRE EDİLEN SATIR
  if (isPickaxe) img.classList.add('fall-anim');
  gameArea.appendChild(img);
  money -= EKIM_MALIYET;
  updateMoneyBar('lose');
  if (mousePos) {
    const barRect = moneyBar.getBoundingClientRect();
    const from = { x: barRect.left + barRect.width / 2 - 10, y: barRect.top + barRect.height / 2 - 14 };
    animateMoneyFloat({ amount: -EKIM_MALIYET, from: from, to: mousePos });
    soundPay.currentTime = 0; soundPay.play();
  }
  return true;
}
function addWheat(x, y) {
  if (!plots.find(p => p.x === x && p.y === y)) return false;
  if (wheats.find(w => w.x === x && w.y === y)) return false;
  if (wheat < 1) return false;
  const barRect = wheatBar.getBoundingClientRect();
  const coords = isoToScreen(x, y);
  const plotPos = { x: coords.left, y: coords.top };
  const barPos = { x: barRect.left + barRect.width / 2 - 16, y: barRect.top + barRect.height / 2 - 16 };
  animateWheatFly({ from: barPos, to: plotPos, count: 1 });
  wheat--;
  updateWheatBar();
  const plotImg = document.getElementById(plotId(x, y));
  if (!plotImg) return false;
  const now = Date.now();
  let wheatObj = {
    x, y,
    plantedAt: now,
    ready: false,
    timerEl: null,
    timerInterval: null,
    harvested: false
  };
  function updateTimer() {
    const elapsed = Math.floor((Date.now() - wheatObj.plantedAt) / 1000);
    const remain = Math.max(0, 6 - elapsed);
    if (wheatObj.harvested) return;
    if (remain > 3) {
      plotImg.src = plot1ImgSrc;
    } else if (remain > 0) {
      plotImg.src = plot2ImgSrc;
    } else {
      plotImg.src = plot3ImgSrc;
      wheatObj.ready = true;
      clearInterval(wheatObj.timerInterval);
    }
  }
  updateTimer();
  wheatObj.timerInterval = setInterval(updateTimer, 400);
  wheats.push(wheatObj);
  return true;
}
function harvestWheat(x, y) {
  const wheatObj = wheats.find(w => w.x === x && w.y === y);
  if (!wheatObj || !wheatObj.ready || wheatObj.harvested) return false;
  wheatObj.harvested = true;
  const plotImg = document.getElementById(plotId(x, y));
  if (plotImg) plotImg.src = plotImgSrc;
  const plotRect = plotImg.getBoundingClientRect();
  const barRect = wheatBar.getBoundingClientRect();
  const from = { x: plotRect.left + plotRect.width/2 - 48, y: plotRect.top + plotRect.height/2 - 48 };
  const to = { x: barRect.left + barRect.width/2 - 48, y: barRect.top + barRect.height/2 - 48 };
  animateWheatFly({from, to, count: 4});
  if (wheatObj.timerInterval) clearInterval(wheatObj.timerInterval);
  wheats = wheats.filter(w => !(w.x === x && w.y === y));
  setTimeout(() => { wheat += 4; updateWheatBar(); }, 500);
  return true;
}
function removePlot(x, y, mousePos = null) {
  const idx = plots.findIndex(p => p.x === x && p.y === y);
  if (idx !== -1) {
    plots.splice(idx, 1);
    const el = document.getElementById(plotId(x, y));
    if (el) {
      el.classList.add('fly-anim');
      el.addEventListener('animationend', () => { if (el && el.parentNode) el.parentNode.removeChild(el); }, {once:true});
    }
    const wheatIdx = wheats.findIndex(w => w.x === x && w.y === y);
    if (wheatIdx !== -1) {
      const wheatObj = wheats[wheatIdx];
      if (wheatObj.timerInterval) clearInterval(wheatObj.timerInterval);
      wheats.splice(wheatIdx, 1);
    }
    money += SILME_KAZANCI;
    updateMoneyBar('gain');
    if (mousePos) {
      const barRect = moneyBar.getBoundingClientRect();
      const to = { x: barRect.left + barRect.width / 2 - 10, y: barRect.top + barRect.height / 2 - 14 };
      animateMoneyFloat({ amount: SILME_KAZANCI, from: mousePos, to: to });
      soundCoin.currentTime = 0; soundCoin.play();
    }
    return true;
  }
  return false;
}
function handleActionAtMouse(e) {
  let clientX, clientY;
  if (e.touches && e.touches.length > 0) {
    clientX = e.touches[0].clientX;
    clientY = e.touches[0].clientY;
  } else {
    clientX = e.clientX; clientY = e.clientY;
  }
  const { x, y } = screenToIso(clientX, clientY);
  const key = `${x},${y}`;
  if (handledCoords.has(key)) return;
  handledCoords.add(key);
  const mousePos = {x: clientX, y: clientY};
  if (isPickaxe) addPlot(x, y, mousePos);
  if (isRemove) removePlot(x, y, mousePos);
  if (isWheat) addWheat(x, y);
  if (isSickle) harvestWheat(x, y);
}

gameArea.addEventListener('mousedown', (e) => {
  if (isPickaxe || isRemove || isWheat || isSickle) {
    isMouseDown = true;
    handledCoords.clear();
    handleActionAtMouse(e);
  }
});
gameArea.addEventListener('mousemove', (e) => {
  if (isMouseDown && (isPickaxe || isRemove || isWheat || isSickle)) {
    handleActionAtMouse(e);
  }
});
document.addEventListener('mouseup', () => { isMouseDown = false; handledCoords.clear(); });
gameArea.addEventListener('mouseleave', () => { isMouseDown = false; handledCoords.clear(); });
gameArea.addEventListener('touchstart', (e) => { if (isPickaxe || isRemove || isWheat || isSickle) { isMouseDown = true; handledCoords.clear(); handleActionAtMouse(e); } });
gameArea.addEventListener('touchmove', (e) => { if (isMouseDown && (isPickaxe || isRemove || isWheat || isSickle)) { handleActionAtMouse(e); } });
gameArea.addEventListener('touchend', () => { isMouseDown = false; handledCoords.clear(); });

document.addEventListener('contextmenu', function(e) { e.preventDefault(); });

function redrawAllPlots() {
  document.querySelectorAll('.iso-plot').forEach(el => el.remove());
  plots.forEach(({x, y}) => {
    const coords = isoToScreen(x, y);
    const img = document.createElement('img');
    img.src = plotImgSrc;
    img.className = "iso-plot";
    img.style.left = coords.left + "px";
    img.style.top = coords.top + "px";
    img.id = plotId(x, y);
    img.style.zIndex = 1000 + (x + y); // ENTEGRE EDİLEN SATIR
    gameArea.appendChild(img);
  });
  wheats.forEach(w => {
    const coords = isoToScreen(w.x, w.y);
    const plotImg = document.getElementById(plotId(w.x, w.y));
    if (!plotImg) return;
    const elapsed = Math.floor((Date.now() - w.plantedAt) / 1000);
    const remain = Math.max(0, 6 - elapsed);

    if (w.harvested) return;

    if (remain > 3) {
      plotImg.src = plot1ImgSrc;
    } else if (remain > 0) {
      plotImg.src = plot2ImgSrc;
    } else {
      plotImg.src = plot3ImgSrc;
      w.ready = true;
    }
  });
}

document.getElementById('wheat-icon').src = wheatImgSrc;
document.getElementById('wheat-price-icon').src = wheatImgSrc;
updateWheatBar();
updateWheatPriceBar();
window.addEventListener('resize', checkOrientation);
window.addEventListener('orientationchange', checkOrientation);

</script>
</body>
</html>
